---
title: "Using energy balances to estimate body temperatures"
author: "Lauren Buckley"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
##Load TrenchR package
library(TrenchR)
```

##Operative environmental temperatures
The body temperatures, $T_b$, of organisms can depart dramatically from the air temperatures due to energy exchange with the environment.  Heat is gained from absorbing solar and thermal radiation and from metabolic reactions. Heat is lost through the organism's emission of radiation and the evaporation of water. The organism exchanges heat with the surrounding air or water via convection and with the ground via conduction. The balance of these heat exchanges can be estimated and is referred to as operatire environmental temperature, $T_e$. $T_e$ indicates the steady-state temperature of an organism with given physical properties in a particular environment [Bakken 1992].

Calculations of operative environmental temperatures are based in balancing energy input and output to organisms.  The following accounting of heat gains and losses at the surface of the organism can be used to estimate $T_e$ [Gates 1980]:
$$Qnet = Qabs - Qemit + Qconv + Qcond + Qmet - Qevap,$$
where $Qnet$ is the net energy exhange with the environment (W), $Qabs$ is the solar and thermal radiation absorbed (W), $Qemit$ is the thermal radiation emitted (W), $Qconv$ is energy exchange due to convection (W), $Qcond$ is energy exchange due to conduction (W),
$Qmet$ is the energy emitted due to metabolism (W), and $Qevap$ is the energy emitted due to evaporative water loss (W).

The energy balance is available in TrenchR as follows:
```{r}
##Qnet_Gates(Qabs=500, Qemit=10, Qconv=100, Qcond=100, Qmet=10, Qevap=5)
```
We briefly review each component of the energy balance below.  Details are available in biophysical ecology texts including [Gates 1980, Cambell and Norman,...].

#Qabs
```{r}
#Qradiation_absorbed(a=0.9, A=1, psa_dir=0.4, psa_ref=0.4, S_dir=1000, S_dif=200, a_s=0.5)
```

#Qemit
```{r}
Qemitted_thermal_radiation(epsilon=0.96, A=1, psa_dir=0.4, psa_ref=0.6, Tb=303, Tg=293, Ta=298, enclosed=FALSE)
```

#Qconv
Animals exchange heat with the air or water they are emersed in at a rate determined by the temperature difference between the temperature of the animal, $T_b$ (K), and that of the air, $T_a$ (K).  The rate is also determined by the animal's surface area exposed to year, which we estimate from the input parameters of the animal's surface area, $A (m^2)$ and the proportion of the surface area in contact with the substrate, $proportion$. A heat transfer coefficient, $H_L (W m^{-2} K^{-1})$, which can be estimated using the relations below, is used to estimate the rate of heat exchange.  An enhancement factor, $ef$, multiplier can also be incorported to account for increases in heat exchange resulting from air turbulance in field conditions. Conduction can be estimated as follows:
$$Qconv= ef*H_L*(A*proportion)*(Ta-Tb).$$

The function is available in R:
```{r}
Qconvection(Ta= 293,Tb= 303,H_L=10.45,A=0.0025, proportion=0.85)
```

The convective heat transfer coefficient depends on whether the heat exchange is free or forced (due to fluid flow). The variables involved in heat transfer can be combined into dimensionless groups that are used to compare the scales of heat exchange processes and thus whether modeling free or forced convection is more appropriate. We provide the primary dimesionless numbers.
\begin{itemize}
\item The Nusselt number provides a dimensionless estimate of conductance as is estimated as $Nu = H_L * D / K$, where $H_L$ is the convective heat transfer coefficient ($W m^{-2} K^{-1}$), D is the characteristic dimension ($m$), and $K$ is thermal conductivity ($W K^{-1}m^{-1}$). 
\item The Prandtl number describes the ratio of kinematic viscosity to thermal diffusivity as $Pr= c_p \mu /K $, where $c_p$ is the specific heat at constant pressure (J mol^{-1} K^{-1}) and $\mu$ is dynamic viscosity ($mol s^{-1}m^{-1}$). 
\item The Reynolds Number indicates the amount of turbulence in air of water flows and is estimated as the ratio of internal viscous forces: $Re= VD / \nu$, where V is wind speed (m/s) and $\nu$ is the kinematic viscosity ($m^2 s^{-1}$), the ratio of dynamic viscosity to the density of the fluid.
\item The Grashof number describes the abilty of a parcel of fluid warmer or colder than the surrounding fluid to rise against or fall with the attractive force of gravity. It is estimated as the ratio of a buoyant force times an inertial force to the square of a viscous force: $ Gr = g D^3 \mid Tg-Ta \mid / (Ta \nu^2)$, where $g$ is gravitational acceleration ($g=9.8 m/s$). 
\end{itemize}

The dimensionless groups are available in R as follows:
```{r}
Nusselt_number(H_L=20, D=0.01, K=0.5)
Prandtl_number(c_p=29.3, mu=0.00001, K=0.5)
Reynolds_number(V=1, D=0.001, nu=1.2)
Grashof_number(Ta=30, Tg=35, D=0.001, nu=1.2)
```

Relations among the dimensionless groups can also be used for estimation. Empirically-derived relationships can be used to estimate the Nusselt number $Nu$ from the Reynolds number $Re$ or the Grashof number $Gr$.  Comparisons of $Gr$ and $Re$ allow determining whether modelling free or forced convection is appropraite.  Forced convection is appropriate when $Gr<= 16 Re^2$. For convenience, we provide the relationships as R functions:
```{r}
Nu_from_Re(Re=5, taxa="cylinder")
Nu_from_Gr(Gr=5)
Free_or_forced_convection(Gr=100, Re=5)
```

Windspeed, $V (m/s)$, can be coupled with dimensionless numbers, which are used to compare the scale of heat exchange processes, to determine whether free or forced convection is more appropriate for the application. 


The primary method we offer to estimate the convective heat transfer coefficient entails approximating the animal shape as a sphere, which enables simplification while also producing an reasonable approximation [Mitchell 1976].  Approximates forced convective heat transfer for animal shapes using the convective relationship for a sphere.

```{r}
heat_transfer_coefficient(V=3,D=0.05,K= 25.7 * 10^(-3),nu= 15.3 * 10^(-6), "cylinder")
```

```{r}
heat_transfer_coefficient_lizard(V=3, orientation="parallel")
```

#Qcond
Animals exchange heat with the substrate and other surfaces via contact proportional to the difference between the surface temperature of the animal, $T_b$ (K), and the substrate temperature, $T_s$ (K). This conduction occurs via diffusion of heat. The extent of energy exchange is additionally determined by the area of contact and the thickness of the skin or other animal suface (assumes a well mixed interior, see XXXX for approaches without this assumption). Finally, the rate of diffusion depends on the thermal conductivity of the materials in contact. Our two basic functions for estimating conduction differ in whether the rate limiting step is the thermal conductivity of the animal (`conductance_animal()`) or the substrate (`conductance_substrate()`). The thermal conductivity of the ground is generally greater than that of animal tissues, so animal thermal conductivity is generally the rate limiting step and most applications should use `conductance_animal`.

Both variables take as parameters the animal's surface area, $A (m^2)$ and the proportion of the surface area in contact with the substrate, $proportion$. 

When animal conductance is the rate limiting step, $Qcond$ can be estimated as follows:
$$Qcond= A*proportion*K*(T_g-T_b)/d, $$
where $K$ is thermal conductivity ($W K^{-1} m^{-1}$), $T_g$ is ground (surface) temperature (K), $T_b$ is body temperature (K), and $d$ is the mean thickness of the animal skin (surface, $m$). This formulation assumes the organism has a well mixed interior rather than an interior temperature gradient.

When substrate thermal conductivity is the rate limiting step, $Qcond$ can be estimated as follows:
$$Qcond= A*proportion*(2K_g/D)*(T_b-T_g),$$
where $K_g$ is the thermal conductivity of substrate ($W K^{-1} m^{-1}$) and $D$ is the characteristic dimension of the animal ($m$).

The functions are available in R:
```{r}
Qconduction_animal(Tg= 293,Tb=303,d=10^-6,K=0.5,A=10^-3, proportion=0.2)
Qconduction_substrate(Tg= 293,Tb=303,D=0.01,K_g=0.3,A=10^-2, proportion=0.2)
```

#Qmet
```{r}
Qmetabolism_from_mass(m=12,"reptile")
```

```{r}
Qmetabolism_from_mass_temp(m=100, Tb=303,"reptile")
```

#Qevap
```{r}
Qevaporation(A=0.1, Tb=293, taxa="amphibian", rho_s=1.2, rho_a=1.2, h=0.5, H_L=20, r_i=5000)
Qevaporation(A=0.1, Tb=293, taxa="lizard")
```

```{r}
saturation_water_vapor_pressure(Ta=20)
external_resistance_to_water_vapor_transfer(H_L=20)
```

#Solving for Te
We currently offer models to calculte the operative temperatures of organisms that have reached an equilibrium with their environment ("steady-state", no heat retention). The following function uses the relationships above to solve the energy balance for $Te$.
```{r}
Tb_Gates(A=1, D=0.001, psa_dir=0.6, psa_ref=0.4, psa_air=0.6, psa_g=0.2, Tg=303, Ta=310, Qabs=800, epsilon=0.95, H_L=10, ef=1.3, K=0.5)

```

Campbell and Norman (XXXX) use a somewhat simplified energy balance to express $Te$ as a function of $Ta$ plus or minus a temperature increment determined by absorbed radiation, wind speed, and animal morphology: 
$$ Te=Ta+(Sabs-Qemit)/(c_p(g_r+g_{Ha})),$$
where $Ta$ is air temperature (K), $Sabs$ is the solar and thermal radiation absorbed ($W m^{-2}$), $Qemit$ is emitted thermal radiation ($W m^{-2}$),$c_p$ is the specific heat of air ($J mol^{-1} K^{-1}$), $g_{r}$ is radiative conductance, and $g_{Ha}$ is the boundary conductance.  The model is based on estimating $T_e$ for a blackbody (perfectly absorbing) cavity with air temperatures equal to surface temperatures ($T_a=T_s$. The model assumes that the cavity provides the same heat load as the nautral environment and thus equates metabolic heat production and evaporative cooling in the two environments.  The formulation assumes a well mixed interior of the animal and also omits conduction with the substrate.  In this scenario, organisms emit thermal radiation from their surface proproportional to the forth power of T_a:
$$Q_{emit}= \epsilon \sigma T_a^4 ,$$
where $\epsilon$ is the proprtional longwave infrared emissivity of skin (0.95-1 for most animals, [Gates 1980]) and $\sigma$ is the Stefan-Boltzmann constant ($5.673*10^{-8} W m^{-2} K^{-4)}$). 

The thermal radiation exchanged between the animals and the walls of the cavity is proportional to the temperature differences and the radiative conductance. Cambell and Norman [XXXX] thus use a denominator term that combines thermal radiative exchange with convective heat exchange. The radiative conductance describing the heat exchange between the core of the animal and the environment is estimated as $g_r= 4 \sigma Ta^3/c_p$ $(mol*m^{-2} s^{-1})$. The boundary conductance (heat exchange with the air via convection) is estimated assuming forced convection driven by naturally turbulent wind and an exmpirical approximation of animal shapes [Mitchell et al. 1976]: 
$$g_{Ha}= 1.4 * 0.135 \sqrt(V/D)$ $(mol*m^{-2} s^{-1}),$$
where 1.4 is a factor to account for increased convection in natural environments, $V$ is wind speed ($m/s$), and $D$ is the characteristic dimension of the animal ($m$).

The function to calculate $T_e$ (called $T_b$ for simplicity) is available in R follows (including the above calculations of $Qemit$, $g_r$, and $g_{Ha}$):
```{r}
Tb_CampbellNorman(Ta=303, Sabs=823, epsilon=0.96, c_p=29.3, D=0.17, V=1)
```

##Alternative energy balance models and functions
#Fei
```{r}
Tb_Fei(254, 265, 267, 15, 307,  0)
```

##Specialized energy balance models and functions
#Lizard
```{r}
#Tb_lizard(Ta=25, Tg=30, u=0.1, svl=60, mass=10, psi=34, rho_S=0.7, elevation=500, doy=200, sun=TRUE, surface=TRUE, alpha_S=0.9, alpha_L=0.965, epsilon_s=0.965, F_d=0.8, F_r=0.5, F_a=0.5, F_g=0.5)
```

#Butterfly
```{r}
#Tb_butterfly(Ta=25, Tg=25, Tg_sh=20, u=0.4, H_sdir=300, H_sdif=100, psi=30, D=0.36, delta=1.46, alpha=0.6, r_g=0.3)
```

#Grasshopper
```{r}
#Tb_grasshopper(Ta=25, Tg=25, u=0.4, rad=400, kt=0.7, psi=30, L=0.02, Acondfact=0.25, z=0.001, abs=0.7, r_g=0.3)
```

#Salamander
```{r}
 Tb_salamander_humid(r_i=4,r_b=1,D=0.007,Ta=20,elev=500,e_a=2.5,e_s=2.3,Qabs=400, epsilon=0.96)
```

```{r}
#actual_vapor_pressure(Tdewpoint=20)
```

```{r}
#saturation_vapor_pressure(Ta=293)
```

```{r}
#boundary_layer_resistance(Ta=293, e_s=2.4, e_a=2.5, elev=500, D=0.007, V=2)
```

```{r}
#Qthermal_radiation_absorbed(Ta=20, epsilon_ground=0.97, a_longwave=0.965)
```

#Frog
Spotila?


#OTHER FUNCTIONS
#Tsoil
```{r}
Tsoil(Tg_max=30, Tg_min=15, hour=12, depth=5)
```

